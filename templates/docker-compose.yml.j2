version: "3.7"
networks:
 {{ nginx_network_name }}:
    driver: overlay
    external: true
{% if create_stack_network is defined and create_stack_network|bool==true %}
 {{ stack_network_name }}:
    driver: overlay
    external: true
{% endif %}    

services:
  redis:
    image: redis:6.0-alpine
    volumes:
      - "{{ mailu_volume_folder }}/redis:/data"
    networks:
      - {{ stack_network_name }}
    deploy:
      restart_policy:
        condition: on-failure

  {{ mailu_db_host }}:
    image: postgres:{{ mailu_postgres_version }}
    volumes:
      - "{{ mailu_volume_folder }}/data/postgres_data:/var/lib/postgresql/data"
      #- "{{ mailu_volume_folder }}/pg_hba.conf:/var/lib/postgresql/data/pg_hba.conf"
    environment:
      POSTGRES_DB: "{{ mailu_db_name }}"
      POSTGRES_USER: "{{ mailu_db_user }}"
      POSTGRES_PASSWORD: "{{ mailu_db_pass }}"
    ports:
      - '5432'      
    networks:
      - {{ stack_network_name }}
    deploy:
      restart_policy:
        condition: on-failure
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U {{ mailu_db_user }}"]
      #test: ["CMD-SHELL", "psql -h 127.0.0.1 -d postgres -U health -c \'select 1 as ok;\' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5        
  
   #HEALTHCHECK &{["CMD-SHELL" "psql -h 127.0.0.1 -d postgres -U health -c \"select 1 as ok;\" || exit 1"] "0s" "0s" "0s" '\x00'}

  front:
    image: mailu/nginx:{{ mailu_version }}
    env_file: "{{ mailu_volume_folder}}/mailu.env"
    environment:
      VIRTUAL_HOST: "{{ nginx_subdomain }}{{ nginx_domain }}"
    volumes:
      - "/etc/letsencrypt/live/{{ nginx_subdomain }}{{ nginx_domain }}/fullchain.pem:/certs/cert.pem"
      - "/etc/letsencrypt/live/{{ nginx_subdomain }}{{ nginx_domain }}/privkey.pem:/certs/key.pem"
      - "{{ mailu_volume_folder }}/overrides/nginx:/overrides:ro"
    logging:
      driver: json-file      
    ports:
      - "80"
      - "443"
      - target: 25
        published: 25
        mode: overlay
      - target: 465
        published: 465
        mode: overlay
      - target: 587
        published: 587
        mode: overlay
      - target: 110
        published: 110
        mode: overlay
      - target: 995
        published: 995
        mode: overlay
      - target: 143
        published: 143
        mode: overlay
      - target: 993
        published: 993
        mode: overlay
    networks:
      - {{ stack_network_name }}
      - {{ nginx_network_name }}
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  admin:
    image: mailu/admin:{{ mailu_version }}
    env_file: "{{ mailu_volume_folder}}/mailu.env"
    volumes:
      - "{{ mailu_volume_folder }}/data:/data"
      - "{{ mailu_volume_folder }}/dkim:/dkim"
      - "./manage.py:/app/mailu/manage.py"
    networks:
      - {{ stack_network_name }}
    deploy:
      restart_policy:
        condition: on-failure
      replicas: 1
    healthcheck:
      disable: true        

  imap:
    image: mailu/dovecot:{{ mailu_version }}
    env_file: "{{ mailu_volume_folder}}/mailu.env"
    volumes:
      - "{{ mailu_volume_folder }}/mail:/mail"
      - "{{ mailu_volume_folder }}/overrides/dovecot:/overrides"
    networks:
      - {{ stack_network_name }}
    deploy:
      restart_policy:
        condition: on-failure
      replicas: 1
    healthcheck:
      disable: true        

  smtp:
    image: mailu/postfix:{{ mailu_version }}
    env_file: "{{ mailu_volume_folder}}/mailu.env"
    environment:
      - POD_ADDRESS_RANGE={{ stack_subnet }}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - "{{ mailu_volume_folder }}/mailqueue:/queue"
      - "{{ mailu_volume_folder }}/overrides/postfix:/overrides:ro"
{% if virtual_corteza is defined and virtual_corteza|bool==true %}      
      - "{{ mailu_volume_folder }}/virtual_alias:/etc/postfix/virtual_alias"
#      - "{{ mailu_volume_folder }}/aliases:/etc/aliases"
#      - "{{ mailu_volume_folder }}/transport_map:/etc/postfix/transport_map"
      - "{{ mailu_volume_folder }}/forward:/root/.forward"
{% endif %}
    networks:
      - {{ stack_network_name }}
    deploy:
      restart_policy:
        condition: on-failure
      replicas: 1
    healthcheck:
      disable: true             

  antispam:
    image: mailu/rspamd:{{ mailu_version }}
    env_file: "{{ mailu_volume_folder}}/mailu.env"
    environment:
      - POD_ADDRESS_RANGE={{ stack_subnet }}    
    volumes:
      - "{{ mailu_volume_folder }}/filter:/var/lib/rspamd"
      - "{{ mailu_volume_folder }}/dkim:/dkim"
      - "{{ mailu_volume_folder }}/overrides/rspamd:/etc/rspamd/override.d:ro"
    networks:
      - {{ stack_network_name }}      
    deploy:
      restart_policy:
        condition: on-failure
      replicas: 1
    healthcheck:
      disable: true             

  # Optional services
  antivirus:
    image: mailu/clamav:{{ mailu_version }}
    env_file: mailu.env
    volumes:
      - "{{ mailu_volume_folder }}/filter:/data"
    networks:
      - {{ stack_network_name }}      
    deploy:
      replicas: 1
    healthcheck:
      disable: true

  webmail:
    image: mailu/rainloop:{{ mailu_version }}
    env_file: "{{ mailu_volume_folder}}/mailu.env"
    volumes:
      - "{{ mailu_volume_folder }}/webmail:/data"
    networks:
      - {{ stack_network_name }}      
    deploy:
      restart_policy:
        condition: on-failure
    deploy:
      replicas: 1
    healthcheck:
      disable: true

  webdav:
    image: mailu/radicale:{{ mailu_version }}
    env_file: "{{ mailu_volume_folder}}/mailu.env"
    volumes:
      - "{{ mailu_volume_folder }}/dav:/data"
    networks:
      - {{ stack_network_name }}            
    deploy:
      replicas: 1
    healthcheck:
      disable: true

  fetchmail:
    image: mailu/fetchmail:{{ mailu_version }}
    env_file: "{{ mailu_volume_folder}}/mailu.env"
    volumes:
      - "{{ mailu_volume_folder }}/data:/data"
    networks:
      - {{ stack_network_name }}          
    deploy:
      replicas: 1
    healthcheck:
      disable: true